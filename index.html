<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snake.io - –í—ã–∂–∏–≤–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div id="score">–û—á–∫–∏: 0</div>
            <div id="rank">–ú–µ—Å—Ç–æ: #1</div>
            <div id="coins">üí∞ 0</div>
            <div id="crystals">üíé 0</div>
            <div id="length">–î–ª–∏–Ω–∞: 5</div>
            
            <!-- –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ -->
            <div id="minimap">
                <canvas id="minimapCanvas"></canvas>
            </div>
            
            <!-- –¢–æ–ø-3 -->
            <div id="top3">
                <h3>üèÜ –¢–û–ü-3</h3>
                <div id="top3List"></div>
            </div>
            
            <!-- –î–∂–æ–π—Å—Ç–∏–∫ -->
            <div id="joystick">
                <div id="joystickBase">
                    <div id="joystickHandle"></div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div id="actionButtons">
                <button id="splitBtn" class="action-btn" title="–†–∞–∑–¥–µ–ª–∏—Ç—å—Å—è (–¥–≤–æ–π–Ω–æ–π —Ç–∞–ø)">‚ö° SPLIT</button>
                <button id="ejectBtn" class="action-btn" title="–í—ã—Å—Ç—Ä–µ–ª –º–∞—Å—Å–æ–π">üí® EJECT</button>
            </div>
            
            <div id="startScreen">
                <div class="screen-title">üêç Snake.io</div>
                <div style="color: #fff; margin-bottom: 20px; text-align: center; padding: 0 20px;">
                    –í—ã–∂–∏–≤–∞–π –∏ —Å—Ç–∞–Ω—å —Å–∞–º–æ–π –±–æ–ª—å—à–æ–π –∑–º–µ–µ–π!
                </div>
                <div style="margin-bottom: 15px; width: 80%; max-width: 300px;">
                    <input type="text" id="playerNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" 
                           style="width: 100%; padding: 12px; font-size: 16px; border-radius: 10px; border: 2px solid #2ECC71; background: rgba(255,255,255,0.1); color: #fff; text-align: center;" 
                           maxlength="15">
                </div>
                <button class="btn" id="startBtn">–ò–ì–†–ê–¢–¨</button>
                <button class="btn btn-secondary" id="shopBtn">–ú–ê–ì–ê–ó–ò–ù</button>
            </div>

            <div id="gameOverScreen">
                <div class="screen-title">–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!</div>
                <div id="finalScore" style="color: #fff; font-size: 32px; margin: 20px 0;">–î–ª–∏–Ω–∞: 0</div>
                <div id="finalRank" style="color: #FFD700; font-size: 24px; margin-bottom: 20px;">–ú–µ—Å—Ç–æ: #0</div>
                <button class="btn" id="restartBtn">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
                <button class="btn btn-secondary" id="shopBtn2">–ú–ê–ì–ê–ó–ò–ù</button>
            </div>

            <div id="shopScreen">
                <div class="screen-title">–ú–ê–ì–ê–ó–ò–ù</div>
                <div class="shop-item">
                    <h3>‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫</h3>
                    <input type="text" id="changeNameInput" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫" 
                           style="width: 80%; padding: 10px; font-size: 16px; border-radius: 10px; border: 2px solid #2ECC71; background: rgba(255,255,255,0.1); color: #fff; text-align: center; margin-bottom: 10px;" 
                           maxlength="15">
                    <button class="btn" onclick="changePlayerName()">–ò–ó–ú–ï–ù–ò–¢–¨ –ù–ò–ö</button>
                </div>
                <div class="shop-item">
                    <h3>üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã</h3>
                    <button class="btn btn-premium" onclick="buyCrystals(50)">50 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ - 99‚ÇΩ</button>
                    <button class="btn btn-premium" onclick="buyCrystals(100)">100 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ - 179‚ÇΩ</button>
                    <button class="btn btn-premium" onclick="buyCrystals(500)">500 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ - 799‚ÇΩ</button>
                </div>
                <div class="shop-item">
                    <h3>üé® –°–∫–∏–Ω—ã –≥–æ–ª–æ–≤—ã</h3>
                    <div class="crystal-price">üíé 15</div>
                    <button class="btn" onclick="buyHeadType('dragon', 15)">üêâ –î—Ä–∞–∫–æ–Ω</button>
                    <button class="btn" onclick="buyHeadType('knight', 15)">‚öîÔ∏è –†—ã—Ü–∞—Ä—å</button>
                    <button class="btn" onclick="buyHeadType('tiger', 15)">üêÖ –¢–∏–≥—Ä</button>
                    <button class="btn" onclick="buyHeadType('wolf', 15)">üê∫ –í–æ–ª–∫</button>
                    <button class="btn" onclick="buyHeadType('eagle', 15)">ü¶Ö –û—Ä–µ–ª</button>
                    <button class="btn" onclick="buyHeadType('lion', 15)">ü¶Å –õ–µ–≤</button>
                    <button class="btn" onclick="buyHeadType('bear', 15)">üêª –ú–µ–¥–≤–µ–¥—å</button>
                </div>
                <div class="shop-item">
                    <h3>‚ö° –ë—É—Å—Ç–µ—Ä—ã</h3>
                    <div class="crystal-price">üíé 15</div>
                    <button class="btn" onclick="buyBooster('speed', 15)">–£—Å–∫–æ—Ä–µ–Ω–∏–µ (30 —Å–µ–∫)</button>
                    <button class="btn" onclick="buyBooster('shield', 15)">–©–∏—Ç (1 —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ)</button>
                </div>
                <button class="btn" id="closeShopBtn">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>
    </div>

    <script>
        // Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) {
            console.error('Canvas not found!');
        }
        const ctx = canvas ? canvas.getContext('2d') : null;
        if (!ctx && canvas) {
            console.error('Cannot get 2d context!');
        }
        const minimapCanvas = document.getElementById('minimapCanvas');
        const minimapCtx = minimapCanvas ? minimapCanvas.getContext('2d') : null;
        const scoreEl = document.getElementById('score');
        const rankEl = document.getElementById('rank');
        const coinsEl = document.getElementById('coins');
        const crystalsEl = document.getElementById('crystals');
        const lengthEl = document.getElementById('length');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const shopScreen = document.getElementById('shopScreen');
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        let startBtn, restartBtn, shopBtn, shopBtn2, closeShopBtn, finalScoreEl, finalRankEl;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
        function resizeCanvas() {
            if (!canvas) return;
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞
            if (minimapCanvas) {
                minimapCanvas.width = minimapCanvas.offsetWidth;
                minimapCanvas.height = minimapCanvas.offsetHeight;
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let gameState = 'menu';
        let gameFrame = 0;
        let score = 0;
        let coins = parseInt(localStorage.getItem('snakeCoins') || '0');
        let crystals = parseInt(localStorage.getItem('snakeCrystals') || '10');
        let currentSkin = localStorage.getItem('snakeSkin') || 'default';
        let activeBoosters = { speed: 0, shield: false };

        // –†–∞–∑–º–µ—Ä –º–∏—Ä–∞ (–±–æ–ª—å—à–∞—è –∫–∞—Ä—Ç–∞)
        const worldWidth = 3000;
        const worldHeight = 3000;
        
        // –ö–∞–º–µ—Ä–∞
        let camera = {
            x: 0,
            y: 0,
            zoom: 1.0 // –ú–∞—Å—à—Ç–∞–± –∫–∞–º–µ—Ä—ã (1.0 = –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, –º–µ–Ω—å—à–µ = –±–æ–ª—å—à–µ –≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å)
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Å—Å—ã
        function calculateLevel(mass) {
            return Math.max(1, Math.floor(mass / 5) + 1);
        }
        
        // –ò–≥—Ä–æ–∫ (–∑–º–µ—è) - –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å—Ç–µ–π (–∫–∞–∫ –≤ Agar.io)
        let player = {
            x: 0,
            y: 0,
            body: [],
            direction: { x: 1, y: 0 },
            speed: 2,
            length: 5,
            mass: 5, // –ú–∞—Å—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞
            level: 1, // –£—Ä–æ–≤–µ–Ω—å –∏–≥—Ä–æ–∫–∞
            color: '#2ECC71',
            headType: 'dragon',
            name: '–í—ã',
            parts: [], // –ß–∞—Å—Ç–∏ –∑–º–µ–π–∫–∏ –ø–æ—Å–ª–µ split
            splitCooldown: 0, // –ö—É–ª–¥–∞—É–Ω –¥–ª—è split
            ejectCooldown: 0, // –ö—É–ª–¥–∞—É–Ω –¥–ª—è eject
            lastFoodTime: 0 // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π)
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Å—Å—ã
        function calculateLevel(mass) {
            return Math.max(1, Math.floor(mass / 5) + 1);
        }

        // –î—Ä—É–≥–∏–µ –∑–º–µ–∏ (–±–æ—Ç—ã –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–Ω–ª–∞–π–Ω)
        let bots = [];
        let food = [];
        let effects = [];
        let viruses = []; // –í–∏—Ä—É—Å—ã/–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–∫–∞–∫ –≤ Agar.io)
        let ejectedMass = []; // –í—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω–∞—è –º–∞—Å—Å–∞
        
        // –¢–∏–ø—ã –≥–æ–ª–æ–≤ –¥–ª—è –∑–º–µ–π
        const headTypes = ['dragon', 'knight', 'tiger', 'wolf', 'snake', 'eagle', 'lion', 'bear'];
        
        // –ò–º–µ–Ω–∞ –¥–ª—è –±–æ—Ç–æ–≤
        const botNames = ['–ó–º–µ–π–∫–∞', '–û—Ö–æ—Ç–Ω–∏–∫', '–•–∏—â–Ω–∏–∫', '–ë—ã—Å—Ç—Ä—ã–π', '–°–∏–ª—å–Ω—ã–π', '–£–º–Ω—ã–π', '–°–º–µ–ª—ã–π', '–õ–æ–≤–∫–∏–π', '–ó–ª–æ–π', '–ë—ã—Å—Ç—Ä—ã–π', '–¢–∏–≥—Ä', '–í–æ–ª–∫'];
        
        // –î–∂–æ–π—Å—Ç–∏–∫
        let joystickActive = false;
        let joystickX = 0;
        let joystickY = 0;
        const joystickBase = document.getElementById('joystickBase');
        const joystickHandle = document.getElementById('joystickHandle');
        const joystickRadius = 60;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            coinsEl.textContent = `üí∞ ${coins}`;
            crystalsEl.textContent = `üíé ${crystals}`;
            lengthEl.textContent = `–£—Ä–æ–≤–µ–Ω—å: ${player.level || 1} | –ú–∞—Å—Å–∞: ${Math.floor(player.mass || player.length)}`;
            scoreEl.textContent = `–û—á–∫–∏: ${score}`;
            
            // –†–∞–Ω–∫ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–æ —Å—Ä–µ–¥–∏ –±–æ—Ç–æ–≤)
            const playerMass = player.mass || player.length;
            const allSnakes = [{ length: playerMass, isPlayer: true }, ...bots.map(b => ({ length: b.length, isPlayer: false }))];
            allSnakes.sort((a, b) => b.length - a.length);
            const rank = allSnakes.findIndex(s => s.isPlayer) + 1;
            rankEl.textContent = `–ú–µ—Å—Ç–æ: #${rank}`;
        }

        updateUI();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            gameFrame = 0;
            score = 0;
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥–æ–ª–æ–≤—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–∫–∏–Ω–∞
            const savedHeadType = localStorage.getItem('snakeSkin') || 'dragon';
            const validHeadTypes = ['dragon', 'knight', 'tiger', 'wolf', 'snake', 'eagle', 'lion', 'bear'];
            const headType = validHeadTypes.includes(savedHeadType) ? savedHeadType : 'dragon';
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –Ω–∏–∫
            const savedName = localStorage.getItem('playerName') || '–í—ã';
            
            player = {
                x: worldWidth / 2,
                y: worldHeight / 2,
                body: [],
                direction: { x: 1, y: 0 },
                speed: 3, // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞)
                length: 5,
                mass: 5,
                level: 1,
                color: getSkinColor(currentSkin),
                headType: headType,
                name: savedName,
                parts: [],
                splitCooldown: 0,
                ejectCooldown: 0,
                lastFoodTime: 0 // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã
            };
            
            // –ù–∞—á–∞–ª—å–Ω–æ–µ —Ç–µ–ª–æ
            for (let i = 0; i < player.length; i++) {
                player.body.push({
                    x: player.x - i * 20,
                    y: player.y
                });
            }

            // –ö–∞–º–µ—Ä–∞ –Ω–∞ –∏–≥—Ä–æ–∫–∞
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;

            // –ë–æ—Ç—ã
            bots = [];
            for (let i = 0; i < 12; i++) {
                bots.push(createBot());
            }

            // –ï–¥–∞
            food = [];
            for (let i = 0; i < 300; i++) {
                createFood();
            }
            
            // –í–∏—Ä—É—Å—ã (–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è)
            viruses = [];
            for (let i = 0; i < 10; i++) {
                createVirus();
            }
            
            // –í—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω–∞—è –º–∞—Å—Å–∞
            ejectedMass = [];

            effects = [];
        }
        
        function createVirus() {
            viruses.push({
                x: Math.random() * worldWidth,
                y: Math.random() * worldHeight,
                size: 30,
                color: '#00ff00',
                spikes: 6 // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∏–ø–æ–≤
            });
        }

        function createBot() {
            const x = Math.random() * worldWidth;
            const y = Math.random() * worldHeight;
            const length = 5 + Math.floor(Math.random() * 20);
            const mass = length;
            const level = calculateLevel(mass);
            const headType = headTypes[Math.floor(Math.random() * headTypes.length)];
            const name = botNames[Math.floor(Math.random() * botNames.length)] + Math.floor(Math.random() * 100);
            
            // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Å—Å—ã (–º–∞–ª–µ–Ω—å–∫–∏–µ –±—ã—Å—Ç—Ä–µ–µ)
            const baseSpeed = 3;
            const speedMultiplier = Math.max(0.4, 1 - (mass - 5) / 80);
            const botSpeed = baseSpeed * speedMultiplier;
            
            const bot = {
                x: x,
                y: y,
                body: [],
                direction: { x: Math.random() - 0.5, y: Math.random() - 0.5 },
                speed: botSpeed,
                length: length,
                mass: mass,
                level: level,
                color: `hsl(${Math.random() * 60 + 180}, 60%, 45%)`,
                headType: headType,
                name: name,
                targetFood: null
            };
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const dirLen = Math.sqrt(bot.direction.x * bot.direction.x + bot.direction.y * bot.direction.y);
            if (dirLen > 0) {
                bot.direction.x /= dirLen;
                bot.direction.y /= dirLen;
            }
            
            // –¢–µ–ª–æ –±–æ—Ç–∞
            for (let i = 0; i < length; i++) {
                bot.body.push({
                    x: bot.x - i * 15,
                    y: bot.y
                });
            }
            
            return bot;
        }

        function createFood() {
            food.push({
                x: Math.random() * worldWidth,
                y: Math.random() * worldHeight,
                size: 8 + Math.random() * 4,
                value: 1,
                color: `hsl(${Math.random() * 40 + 30}, 80%, 55%)`
            });
        }

        function getSkinColor(skin) {
            switch(skin) {
                case 'rainbow': return 'rainbow';
                case 'gold': return '#FFA500';
                case 'neon': return '#4A90E2';
                default: return '#2ECC71';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        function update() {
            if (gameState !== 'playing') return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ player —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!player || !player.body) return;

            gameFrame++;

            // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            player.x += player.direction.x * player.speed;
            player.y += player.direction.y * player.speed;

            // –ì—Ä–∞–Ω–∏—Ü—ã –º–∏—Ä–∞ (—Ç–µ–ª–µ–ø–æ—Ä—Ç)
            if (player.x < 0) player.x = worldWidth;
            if (player.x > worldWidth) player.x = 0;
            if (player.y < 0) player.y = worldHeight;
            if (player.y > worldHeight) player.y = 0;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –∫–∞–º–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞ –∏–≥—Ä–æ–∫–∞
            // –ß–µ–º –±–æ–ª—å—à–µ –∑–º–µ–π–∫–∞, —Ç–µ–º –º–µ–Ω—å—à–µ –º–∞—Å—à—Ç–∞–± (–±–æ–ª—å—à–µ –≤–∏–¥–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å)
            const baseMass = 5; // –ë–∞–∑–æ–≤–∞—è –º–∞—Å—Å–∞
            const maxMass = 200; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–∞—Å—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
            const minZoom = 0.4; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–¥–∞–ª–µ–Ω–∏–µ)
            const maxZoom = 1.0; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –≤–∏–¥)
            
            const playerMass = player.mass || player.length;
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞ –æ—Ç 1.0 –¥–æ 0.4 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Å—Å—ã
            const massRatio = Math.min(1, Math.max(0, (playerMass - baseMass) / (maxMass - baseMass)));
            const targetZoom = maxZoom - (maxZoom - minZoom) * massRatio;
            
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤)
            camera.zoom += (targetZoom - camera.zoom) * 0.05;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (—Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º)
            // –£—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã
            const viewWidth = canvas.width / camera.zoom;
            const viewHeight = canvas.height / camera.zoom;
            camera.x = player.x - viewWidth / 2;
            camera.y = player.y - viewHeight / 2;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –º–∏—Ä–∞ (—Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞)
            camera.x = Math.max(0, Math.min(camera.x, worldWidth - viewWidth));
            camera.y = Math.max(0, Math.min(camera.y, worldHeight - viewHeight));

            // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–ª–æ (–¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≥–æ–ª–æ–≤—ã)
            player.body.unshift({ x: player.x, y: player.y });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É—Å—Ç–µ—Ä–æ–≤
            if (activeBoosters.speed > 0) {
                activeBoosters.speed--;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–æ–≤
            if (player.splitCooldown > 0) player.splitCooldown--;
            if (player.ejectCooldown > 0) player.ejectCooldown--;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Å—Å—ã
            player.level = calculateLevel(player.mass);
            
            // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Å—Å—ã (–º–∞–ª–µ–Ω—å–∫–∏–µ –±—ã—Å—Ç—Ä–µ–µ, –±–æ–ª—å—à–∏–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
            const baseSpeed = 3; // –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —á–µ—Ä–≤—è–∫–æ–≤
            const speedMultiplier = Math.max(0.3, 1 - (player.mass - 5) / 70); // –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
            player.speed = baseSpeed * speedMultiplier + (activeBoosters.speed > 0 ? 0.8 : 0);

            // –°–±–æ—Ä –µ–¥—ã (–ü–ï–†–ï–î –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π —Ü–∏–∫–ª, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            for (let i = food.length - 1; i >= 0; i--) {
                const f = food[i];
                const dist = Math.sqrt(Math.pow(player.x - f.x, 2) + Math.pow(player.y - f.y, 2));
                const playerSize = 8 + (player.mass * 0.8);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥ —Å–±–æ—Ä–∞ –µ–¥—ã –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è
                if (dist < f.size + playerSize * 0.8) {
                    player.length += f.value;
                    player.mass += f.value;
                    player.level = calculateLevel(player.mass); // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
                    score += f.value * 10;
                    coins += f.value;
                    createCollectEffect(player.x, player.y, f.color);
                    food.splice(i, 1);
                    createFood();
                    player.lastFoodTime = gameFrame; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã
                    updateUI();
                    localStorage.setItem('snakeCoins', coins);
                }
            }
            
            // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥—ã –Ω–∞ –∫–∞—Ä—Ç–µ
            while (food.length < 300) {
                createFood();
            }
            
            // –°–±–æ—Ä –≤—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω–æ–π –º–∞—Å—Å—ã
            ejectedMass.forEach((mass, index) => {
                const dist = Math.sqrt(Math.pow(player.x - mass.x, 2) + Math.pow(player.y - mass.y, 2));
                const playerSize = 8 + (player.mass * 0.8);
                if (dist < mass.size + playerSize) {
                    player.length += mass.value;
                    player.mass += mass.value;
                    score += mass.value * 5;
                    ejectedMass.splice(index, 1);
                    updateUI();
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω–æ–π –º–∞—Å—Å—ã
            ejectedMass.forEach(mass => {
                mass.life--;
                if (mass.life <= 0) {
                    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –µ–¥—É
                    food.push({
                        x: mass.x,
                        y: mass.y,
                        size: mass.size,
                        value: mass.value,
                        color: mass.color
                    });
                }
            });
            ejectedMass = ejectedMass.filter(m => m.life > 0);
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –≤–∏—Ä—É—Å–∞–º–∏
            viruses.forEach((virus, index) => {
                const dist = Math.sqrt(Math.pow(player.x - virus.x, 2) + Math.pow(player.y - virus.y, 2));
                const playerSize = 8 + (player.mass * 0.8);
                if (dist < virus.size + playerSize) {
                    // –ï—Å–ª–∏ –∑–º–µ–π–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∞—è - —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è
                    if (player.mass > 35) {
                        splitSnake();
                        createKillEffect(virus.x, virus.y);
                    } else {
                        // –ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç
                        const angle = Math.atan2(player.y - virus.y, player.x - virus.x);
                        player.x += Math.cos(angle) * 5;
                        player.y += Math.sin(angle) * 5;
                    }
                }
            });
            
            // –¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–ª–∞ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –µ–¥—ã
            // –î–µ–ª–∞–µ–º —ç—Ç–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∑–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const targetLength = player.length;
            while (player.body.length > targetLength) {
                player.body.pop();
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–µ–ª–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
            if (player.body.length < targetLength) {
                const lastSegment = player.body[player.body.length - 1] || { x: player.x, y: player.y };
                for (let i = player.body.length; i < targetLength; i++) {
                    player.body.push({
                        x: lastSegment.x,
                        y: lastSegment.y
                    });
                }
            }

            // –î–≤–∏–∂–µ–Ω–∏–µ –±–æ—Ç–æ–≤
            bots.forEach((bot, botIndex) => {
                // AI –±–æ—Ç–∞ - –∏—â–µ—Ç –±–ª–∏–∂–∞–π—à—É—é –µ–¥—É
                let nearestFood = null;
                let minDist = Infinity;
                food.forEach(f => {
                    const dist = Math.sqrt(Math.pow(bot.x - f.x, 2) + Math.pow(bot.y - f.y, 2));
                    if (dist < minDist) {
                        minDist = dist;
                        nearestFood = f;
                    }
                });

                if (nearestFood) {
                    const dx = nearestFood.x - bot.x;
                    const dy = nearestFood.y - bot.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    bot.direction.x = dx / dist;
                    bot.direction.y = dy / dist;
                } else {
                    // –°–ª—É—á–∞–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                    if (Math.random() < 0.05) {
                        bot.direction.x = Math.random() - 0.5;
                        bot.direction.y = Math.random() - 0.5;
                    }
                }

                bot.x += bot.direction.x * bot.speed;
                bot.y += bot.direction.y * bot.speed;

                // –ì—Ä–∞–Ω–∏—Ü—ã –º–∏—Ä–∞
                if (bot.x < 0) bot.x = worldWidth;
                if (bot.x > worldWidth) bot.x = 0;
                if (bot.y < 0) bot.y = worldHeight;
                if (bot.y > worldHeight) bot.y = 0;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–∞ –±–æ—Ç–∞
                bot.body.unshift({ x: bot.x, y: bot.y });
                while (bot.body.length > bot.length) {
                    bot.body.pop();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –±–æ—Ç–∞
                bot.mass = bot.length;
                bot.level = calculateLevel(bot.mass);
                const botBaseSpeed = 3;
                const botSpeedMultiplier = Math.max(0.4, 1 - (bot.mass - 5) / 80);
                bot.speed = botBaseSpeed * botSpeedMultiplier;

                // –ë–æ—Ç —Å–æ–±–∏—Ä–∞–µ—Ç –µ–¥—É
                food.forEach((f, index) => {
                    const dist = Math.sqrt(Math.pow(bot.x - f.x, 2) + Math.pow(bot.y - f.y, 2));
                    if (dist < f.size + 15) {
                        bot.length += f.value;
                        bot.mass += f.value;
                        bot.level = calculateLevel(bot.mass);
                        food.splice(index, 1);
                        createFood();
                    }
                });
            });

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∑–º–µ—è–º–∏
            bots.forEach((bot, botIndex) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –≥–æ–ª–æ–≤—ã –∏–≥—Ä–æ–∫–∞ —Å —Ç–µ–ª–æ–º –±–æ—Ç–∞
                if (bot.body.length > 0) {
                    const botHead = bot.body[0];
                    const distToBotHead = Math.sqrt(Math.pow(player.x - botHead.x, 2) + Math.pow(player.y - botHead.y, 2));
                    
                    // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –±–æ–ª—å—à–µ –±–æ—Ç–∞ - —Å—ä–µ–¥–∞–µ–º –µ–≥–æ
                    const playerMass = player.mass || player.length;
                    const botMass = bot.mass || bot.length;
                    const playerSize = 8 + (playerMass * 0.8);
                    const botSize = 8 + (botMass * 0.8);
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥ –¥–ª—è –ø–æ–µ–¥–∞–Ω–∏—è –±–æ—Ç–∞
                    if (distToBotHead < (playerSize + botSize) * 0.6 && playerMass > botMass) {
                        // –ò–≥—Ä–æ–∫ —Å—ä–µ–¥–∞–µ—Ç –±–æ—Ç–∞
                        const gainedMass = Math.floor(botMass / 2);
                        player.length += gainedMass;
                        player.mass += gainedMass;
                        score += botMass * 5;
                        coins += gainedMass;
                        createKillEffect(bot.x, bot.y);
                        bots[botIndex] = createBot();
                        updateUI();
                        localStorage.setItem('snakeCoins', coins);
                        return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–∞–ª—å—à–µ
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Ç–µ–ª–æ–º –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ—Ç –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–û –±–æ–ª—å—à–µ –∏–≥—Ä–æ–∫–∞)
                    // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
                    // –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã
                    if (botMass > playerMass * 1.5 && (!player.lastFoodTime || !gameFrame || (gameFrame - player.lastFoodTime) > 30)) {
                        bot.body.forEach((segment, index) => {
                            if (index < 20) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 20 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (—É–≤–µ–ª–∏—á–µ–Ω–æ —Å 10)
                            
                            const playerSize = 8 + (playerMass * 0.8);
                            const botSize = 8 + (botMass * 0.8);
                            const dist = Math.sqrt(Math.pow(player.x - segment.x, 2) + Math.pow(player.y - segment.y, 2));
                            
                            // –û–ß–ï–ù–¨ —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä–æ–≥ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
                            // –£–º–µ–Ω—å—à–∞–µ–º –ø–æ—Ä–æ–≥ –¥–æ 20% —Å—É–º–º—ã —Ä–∞–∑–º–µ—Ä–æ–≤ (–±—ã–ª–æ 30%)
                            // –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Ä–µ–∑–∞—Ç—å—Å—è
                            if (dist < (playerSize + botSize) * 0.2) {
                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–≥—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–≤–∏–∂–µ—Ç—Å—è –∫ —Å–µ–≥–º–µ–Ω—Ç—É
                                const angleToSegment = Math.atan2(segment.y - player.y, segment.x - player.x);
                                const playerAngle = Math.atan2(player.direction.y, player.direction.x);
                                const angleDiff = Math.abs(angleToSegment - playerAngle);
                                const minAngleDiff = Math.min(angleDiff, Math.PI * 2 - angleDiff);
                                
                                // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –¥–≤–∏–∂–µ—Ç—Å—è –ù–ê–í–°–¢–†–ï–ß–£ —Å–µ–≥–º–µ–Ω—Ç—É (–Ω–µ —É–±–µ–≥–∞–µ—Ç)
                                if (minAngleDiff < Math.PI / 2) { // –î–≤–∏–∂–µ—Ç—Å—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–µ–≥–º–µ–Ω—Ç–∞
                                    if (!activeBoosters.shield) {
                                        gameOver();
                                        return;
                                    } else {
                                        activeBoosters.shield = false;
                                        createShieldEffect(player.x, player.y);
                                    }
                                }
                            }
                        });
                    }
                }
            });

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–µ–ª–æ–º (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–ª–∏–Ω–∞ –±–æ–ª—å—à–µ 100)
            // –ò —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã (–º–∏–Ω–∏–º—É–º 30 –∫–∞–¥—Ä–æ–≤)
            if (player.length > 100 && player.body.length > 100 && (!player.lastFoodTime || !gameFrame || (gameFrame - player.lastFoodTime) > 30)) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–≥–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–ª–µ–∫–æ –æ—Ç –≥–æ–ª–æ–≤—ã
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 70 —Å–µ–≥–º–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
                player.body.forEach((segment, index) => {
                    if (index < 70) return; // –ü–µ—Ä–≤—ã–µ 70 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è (—É–≤–µ–ª–∏—á–µ–Ω–æ —Å 50)
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–º–µ—Ä–∞ –∏–≥—Ä–æ–∫–∞
                    const playerSize = 8 + (player.mass * 0.8);
                    const dist = Math.sqrt(Math.pow(player.x - segment.x, 2) + Math.pow(player.y - segment.y, 2));
                    
                    // –û–ß–ï–ù–¨ —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä–æ–≥ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
                    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ (–º–µ–Ω—å—à–µ 15% —Ä–∞–∑–º–µ—Ä–∞, –±—ã–ª–æ 20%)
                    if (dist < playerSize * 0.15) {
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–≥—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–≤–∏–∂–µ—Ç—Å—è –∫ —Å–≤–æ–µ–º—É —Ç–µ–ª—É
                        const angleToSegment = Math.atan2(segment.y - player.y, segment.x - player.x);
                        const playerAngle = Math.atan2(player.direction.y, player.direction.x);
                        const angleDiff = Math.abs(angleToSegment - playerAngle);
                        const minAngleDiff = Math.min(angleDiff, Math.PI * 2 - angleDiff);
                        
                        // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –¥–≤–∏–∂–µ—Ç—Å—è –ù–ê–í–°–¢–†–ï–ß–£ —Å–≤–æ–µ–º—É —Ç–µ–ª—É (–Ω–µ —É–±–µ–≥–∞–µ—Ç)
                        if (minAngleDiff < Math.PI / 2) { // –î–≤–∏–∂–µ—Ç—Å—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–µ–≥–º–µ–Ω—Ç–∞
                            if (!activeBoosters.shield) {
                                gameOver();
                                return;
                            } else {
                                activeBoosters.shield = false;
                                createShieldEffect(player.x, player.y);
                            }
                        }
                    }
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–µ–π –∑–º–µ–π–∫–∏ –ø–æ—Å–ª–µ split
            updateSnakeParts();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω–æ–π –º–∞—Å—Å—ã (–¥–≤–∏–∂–µ–Ω–∏–µ)
            ejectedMass.forEach(mass => {
                mass.x += mass.vx;
                mass.y += mass.vy;
                mass.vx *= 0.98; // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ
                mass.vy *= 0.98;
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            effects = effects.filter(effect => {
                effect.life--;
                effect.x += effect.vx || 0;
                effect.y += effect.vy || 0;
                effect.alpha = effect.life / effect.maxLife;
                effect.size *= 0.98;
                return effect.life > 0;
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function draw() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ canvas –∏ ctx —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            if (!canvas || !ctx) return;
            
            // –í—Å–µ–≥–¥–∞ —Ä–∏—Å—É–µ–º —Ñ–æ–Ω
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ï—Å–ª–∏ –Ω–µ –∏–≥—Ä–∞–µ–º, –Ω–µ —Ä–∏—Å—É–µ–º –∏–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
            if (gameState !== 'playing') return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ player —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!player || !player.body) return;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
            const viewWidth = canvas.width / camera.zoom;
            const viewHeight = canvas.height / camera.zoom;
            const viewOffsetX = (canvas.width - viewWidth) / 2;
            const viewOffsetY = (canvas.height - viewHeight) / 2;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
            ctx.save();
            ctx.translate(viewOffsetX, viewOffsetY);
            ctx.scale(camera.zoom, camera.zoom);

            // –°–µ—Ç–∫–∞ —Å —É—á–µ—Ç–æ–º –∫–∞–º–µ—Ä—ã
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1 / camera.zoom; // –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –ª–∏–Ω–∏–π
            const gridStartX = Math.floor(camera.x / 50) * 50;
            const gridStartY = Math.floor(camera.y / 50) * 50;
            
            for (let x = gridStartX; x < camera.x + viewWidth; x += 50) {
                const screenX = x - camera.x;
                ctx.beginPath();
                ctx.moveTo(screenX, 0);
                ctx.lineTo(screenX, viewHeight);
                ctx.stroke();
            }
            for (let y = gridStartY; y < camera.y + viewHeight; y += 50) {
                const screenY = y - camera.y;
                ctx.beginPath();
                ctx.moveTo(0, screenY);
                ctx.lineTo(viewWidth, screenY);
                ctx.stroke();
            }

            // –ï–¥–∞ (–∫—Ä–∞—Å–∏–≤—ã–µ —è–±–ª–æ–∫–∏/—Ñ—Ä—É–∫—Ç—ã) —Å —É—á–µ—Ç–æ–º –∫–∞–º–µ—Ä—ã
            food.forEach(f => {
                const screenX = f.x - camera.x;
                const screenY = f.y - camera.y;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                if (screenX < -50 || screenX > viewWidth + 50 || 
                    screenY < -50 || screenY > viewHeight + 50) return;
                
                const pulse = Math.sin(gameFrame * 0.15 + f.x * 0.1) * 1.5;
                const size = f.size + pulse;
                
                // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç
                ctx.fillStyle = f.color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, size, 0, Math.PI * 2);
                ctx.fill();
                
                // –ë–ª–∏–∫
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.beginPath();
                ctx.arc(screenX - size * 0.3, screenY - size * 0.3, size * 0.4, 0, Math.PI * 2);
                ctx.fill();
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });

            // –ë–æ—Ç—ã (—Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ)
            bots.forEach(bot => {
                const botScreenX = bot.x - camera.x;
                const botScreenY = bot.y - camera.y;
                if (botScreenX > -100 && botScreenX < viewWidth + 100 &&
                    botScreenY > -100 && botScreenY < viewHeight + 100) {
                    // –†–∞–∑–º–µ—Ä –±–æ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Å—Å—ã (–±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)
                    const botMass = bot.mass || bot.length;
                    const botSize = 8 + (botMass * 0.8); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –º–∞—Å—Å—ã
                    drawSnake(bot.body, bot.color, false, bot.headType, bot.direction, botSize, viewWidth, viewHeight);
                    // –ù–∏–∫ –±–æ—Ç–∞ —Å —É—Ä–æ–≤–Ω–µ–º
                    if (bot.body.length > 0) {
                        const headScreenX = bot.body[0].x - camera.x;
                        const headScreenY = bot.body[0].y - camera.y;
                        drawName(headScreenX, headScreenY - 25, bot.name, bot.color, bot.level || calculateLevel(botMass));
                    }
                }
            });

            // –í–∏—Ä—É—Å—ã (–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è) —Å —É—á–µ—Ç–æ–º –∫–∞–º–µ—Ä—ã
            viruses.forEach(virus => {
                const screenX = virus.x - camera.x;
                const screenY = virus.y - camera.y;
                
                if (screenX < -100 || screenX > viewWidth + 100 || 
                    screenY < -100 || screenY > viewHeight + 100) return;
                
                // –†–∏—Å—É–µ–º –≤–∏—Ä—É—Å —Å —à–∏–ø–∞–º–∏
                ctx.fillStyle = virus.color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, virus.size, 0, Math.PI * 2);
                ctx.fill();
                
                // –®–∏–ø—ã
                ctx.strokeStyle = '#00cc00';
                ctx.lineWidth = 3;
                for (let i = 0; i < virus.spikes; i++) {
                    const angle = (Math.PI * 2 / virus.spikes) * i + gameFrame * 0.02;
                    const spikeX = screenX + Math.cos(angle) * virus.size;
                    const spikeY = screenY + Math.sin(angle) * virus.size;
                    ctx.beginPath();
                    ctx.moveTo(screenX, screenY);
                    ctx.lineTo(spikeX, spikeY);
                    ctx.stroke();
                }
                
                // –û–±–≤–æ–¥–∫–∞
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // –í—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω–∞—è –º–∞—Å—Å–∞
            ejectedMass.forEach(mass => {
                const screenX = mass.x - camera.x;
                const screenY = mass.y - camera.y;
                
                if (screenX < -50 || screenX > viewWidth + 50 || 
                    screenY < -50 || screenY > viewHeight + 50) return;
                
                ctx.fillStyle = mass.color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, mass.size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
            
            // –ò–≥—Ä–æ–∫
            if (player && player.body && player.body.length > 0) {
                // –†–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Å—Å—ã (–±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)
                const playerSize = 8 + (player.mass * 0.8); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –º–∞—Å—Å—ã
                drawSnake(player.body, player.color, true, player.headType, player.direction, playerSize, viewWidth, viewHeight);
                // –ù–∏–∫ –∏–≥—Ä–æ–∫–∞
                const headScreenX = player.body[0].x - camera.x;
                const headScreenY = player.body[0].y - camera.y;
                drawName(headScreenX, headScreenY - 25, player.name || '–í—ã', player.color, player.level);
            }
            
            // –ß–∞—Å—Ç–∏ –∑–º–µ–π–∫–∏ –ø–æ—Å–ª–µ split
            player.parts.forEach(part => {
                if (part.body.length > 0) {
                    const partSize = 8 + (part.mass * 0.8); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –º–∞—Å—Å—ã
                    const partScreenX = part.body[0].x - camera.x;
                    const partScreenY = part.body[0].y - camera.y;
                    if (partScreenX > -100 && partScreenX < canvas.width + 100 &&
                        partScreenY > -100 && partScreenY < canvas.height + 100) {
                        drawSnake(part.body, part.color, false, part.headType, part.direction, partSize, viewWidth, viewHeight);
                        const partLevel = calculateLevel(part.mass);
                        drawName(partScreenX, partScreenY - 25, part.name, part.color, partLevel);
                    }
                }
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            ctx.restore();
            
            // –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ (—Ä–∏—Å—É–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
            drawMinimap();
            
            // –¢–æ–ø-3
            updateTop3();

            // –≠—Ñ—Ñ–µ–∫—Ç—ã (—Å —É—á–µ—Ç–æ–º –∫–∞–º–µ—Ä—ã)
            effects.forEach(effect => {
                const screenX = effect.x - camera.x;
                const screenY = effect.y - camera.y;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                if (screenX < -50 || screenX > viewWidth + 50 || 
                    screenY < -50 || screenY > viewHeight + 50) return;
                
                ctx.save();
                ctx.globalAlpha = effect.alpha;
                ctx.fillStyle = effect.color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, effect.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 20;
                ctx.shadowColor = effect.color;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.restore();
            });
        }

        function drawSnake(body, color, isPlayer, headType = 'dragon', direction = { x: 1, y: 0 }, baseSize = null, viewWidth = null, viewHeight = null) {
            const defaultSize = isPlayer ? 16 : 13;
            const segmentSize = baseSize || defaultSize;
            
            // –í—ã—á–∏—Å–ª—è–µ–º viewWidth –∏ viewHeight, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã
            if (!viewWidth || !viewHeight) {
                viewWidth = canvas.width / camera.zoom;
                viewHeight = canvas.height / camera.zoom;
            }
            
            body.forEach((segment, index) => {
                // –†–∞–∑–º–µ—Ä —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –∫ —Ö–≤–æ—Å—Ç—É
                const size = segmentSize * (1 - (index / body.length) * 0.3);
                const alpha = 1 - (index / body.length) * 0.4;
                
                // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                const screenX = segment.x - camera.x;
                const screenY = segment.y - camera.y;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                if (screenX < -50 || screenX > viewWidth + 50 || 
                    screenY < -50 || screenY > viewHeight + 50) return;
                
                if (color === 'rainbow') {
                    const hue = (gameFrame * 3 + index * 8) % 360;
                    ctx.fillStyle = `hsl(${hue}, 70%, 55%)`;
                } else {
                    ctx.fillStyle = color;
                }
                
                ctx.globalAlpha = alpha;
                
                // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä—É–≥
                ctx.beginPath();
                ctx.arc(screenX, screenY, size, 0, Math.PI * 2);
                ctx.fill();
                
                // –û–±–≤–æ–¥–∫–∞ (–±–æ–ª–µ–µ –º—è–≥–∫–∞—è)
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥ –¥–ª—è –æ–±—ä–µ–º–∞
                if (index < body.length * 0.7) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.arc(screenX - size * 0.3, screenY - size * 0.3, size * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // –ì–æ–ª–æ–≤–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
                if (index === 0) {
                    drawHead(screenX, screenY, headType, direction, size);
                }
                
                ctx.globalAlpha = 1;
            });
        }
        
        function drawHead(x, y, headType, direction, size) {
            ctx.save();
            ctx.translate(x, y);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞
            let angle = 0;
            if (direction.x !== 0 || direction.y !== 0) {
                angle = Math.atan2(direction.y, direction.x);
            }
            ctx.rotate(angle);
            
            switch(headType) {
                case 'dragon':
                    // –î—Ä–∞–∫–æ–Ω - —Ä–æ–≥–∞ –∏ —á–µ—à—É—è
                    ctx.fillStyle = '#E74C3C';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –†–æ–≥–∞
                    ctx.fillStyle = '#C0392B';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.5, -size);
                    ctx.lineTo(-size * 0.3, -size * 1.5);
                    ctx.lineTo(-size * 0.1, -size);
                    ctx.closePath();
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(size * 0.5, -size);
                    ctx.lineTo(size * 0.3, -size * 1.5);
                    ctx.lineTo(size * 0.1, -size);
                    ctx.closePath();
                    ctx.fill();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 3, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 3, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'knight':
                    // –†—ã—Ü–∞—Ä—å - —à–ª–µ–º
                    ctx.fillStyle = '#34495E';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –®–ª–µ–º
                    ctx.fillStyle = '#2C3E50';
                    ctx.beginPath();
                    ctx.arc(0, -size * 0.3, size * 0.8, 0, Math.PI, true);
                    ctx.fill();
                    // –ó–∞–±—Ä–∞–ª–æ
                    ctx.strokeStyle = '#1A1A1A';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.3, -size * 0.5);
                    ctx.lineTo(size * 0.3, -size * 0.5);
                    ctx.stroke();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(-size * 0.3, -size * 0.3, 2, 0, Math.PI * 2);
                    ctx.arc(size * 0.3, -size * 0.3, 2, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'tiger':
                    // –¢–∏–≥—Ä - –ø–æ–ª–æ—Å–∫–∏
                    ctx.fillStyle = '#F39C12';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –ü–æ–ª–æ—Å–∫–∏
                    ctx.fillStyle = '#000';
                    ctx.fillRect(-size * 0.8, -size * 0.3, size * 0.3, size * 0.2);
                    ctx.fillRect(size * 0.5, -size * 0.3, size * 0.3, size * 0.2);
                    // –£—à–∏
                    ctx.fillStyle = '#E67E22';
                    ctx.beginPath();
                    ctx.arc(-size * 0.6, -size * 0.8, size * 0.4, 0, Math.PI * 2);
                    ctx.arc(size * 0.6, -size * 0.8, size * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 3, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 1.5, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'wolf':
                    // –í–æ–ª–∫ - –∑–∞–æ—Å—Ç—Ä–µ–Ω–Ω—ã–µ —É—à–∏
                    ctx.fillStyle = '#95A5A6';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –£—à–∏
                    ctx.fillStyle = '#7F8C8D';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.5, -size);
                    ctx.lineTo(-size * 0.2, -size * 1.3);
                    ctx.lineTo(0, -size * 0.8);
                    ctx.closePath();
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(size * 0.5, -size);
                    ctx.lineTo(size * 0.2, -size * 1.3);
                    ctx.lineTo(0, -size * 0.8);
                    ctx.closePath();
                    ctx.fill();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#E74C3C';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 2.5, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 2.5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'eagle':
                    // –û—Ä–µ–ª - –∫–ª—é–≤
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –ö–ª—é–≤
                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.moveTo(size, 0);
                    ctx.lineTo(size * 1.5, size * 0.3);
                    ctx.lineTo(size, size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.3, 3, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.3, 3, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'lion':
                    // –õ–µ–≤ - –≥—Ä–∏–≤–∞
                    ctx.fillStyle = '#F39C12';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –ì—Ä–∏–≤–∞
                    ctx.fillStyle = '#E67E22';
                    for (let i = 0; i < 8; i++) {
                        const angle = (Math.PI * 2 / 8) * i;
                        const px = Math.cos(angle) * size;
                        const py = Math.sin(angle) * size;
                        ctx.beginPath();
                        ctx.arc(px, py, size * 0.4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 2, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 2, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'bear':
                    // –ú–µ–¥–≤–µ–¥—å - –∫—Ä—É–≥–ª—ã–µ —É—à–∏
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –£—à–∏
                    ctx.fillStyle = '#654321';
                    ctx.beginPath();
                    ctx.arc(-size * 0.6, -size * 0.7, size * 0.4, 0, Math.PI * 2);
                    ctx.arc(size * 0.6, -size * 0.7, size * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 2.5, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 2.5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                default: // snake –∏–ª–∏ –¥—Ä—É–≥–∏–µ
                    // –ü—Ä–æ—Å—Ç–∞—è –∑–º–µ—è
                    ctx.fillStyle = '#2ECC71';
                    ctx.beginPath();
                    ctx.arc(0, 0, size, 0, Math.PI * 2);
                    ctx.fill();
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 3, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-size * 0.4, -size * 0.2, 1.5, 0, Math.PI * 2);
                    ctx.arc(size * 0.4, -size * 0.2, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                    break;
            }
            
            ctx.restore();
        }
        
        function drawName(x, y, name, color, level = null) {
            ctx.save();
            
            // –¢–µ–∫—Å—Ç —Å —É—Ä–æ–≤–Ω–µ–º
            const displayText = level !== null ? `Lv.${level} ${name}` : name;
            
            // –§–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            const textWidth = ctx.measureText(displayText).width;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(x - textWidth / 2 - 5, y - 12, textWidth + 10, 16);
            
            // –¢–µ–∫—Å—Ç
            ctx.fillStyle = color;
            ctx.fillText(displayText, x, y);
            
            ctx.restore();
        }
        
        function drawMinimap() {
            if (!minimapCanvas || !minimapCtx) return;
            
            if (gameState !== 'playing') {
                minimapCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);
                return;
            }
            
            minimapCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);
            
            const scaleX = minimapCanvas.width / worldWidth;
            const scaleY = minimapCanvas.height / worldHeight;
            
            // –ï–¥–∞ –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ
            minimapCtx.fillStyle = 'rgba(255, 255, 0, 0.3)';
            food.forEach(f => {
                const mx = f.x * scaleX;
                const my = f.y * scaleY;
                minimapCtx.fillRect(mx - 1, my - 1, 2, 2);
            });
            
            // –ë–æ—Ç—ã –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ
            bots.forEach(bot => {
                if (bot.body.length > 0) {
                    const mx = bot.body[0].x * scaleX;
                    const my = bot.body[0].y * scaleY;
                    minimapCtx.fillStyle = bot.color;
                    minimapCtx.beginPath();
                    minimapCtx.arc(mx, my, 2, 0, Math.PI * 2);
                    minimapCtx.fill();
                }
            });
            
            // –ò–≥—Ä–æ–∫ –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ
            if (player.body.length > 0) {
                const mx = player.body[0].x * scaleX;
                const my = player.body[0].y * scaleY;
                minimapCtx.fillStyle = '#2ECC71';
                minimapCtx.beginPath();
                minimapCtx.arc(mx, my, 3, 0, Math.PI * 2);
                minimapCtx.fill();
                
                // –û–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
                minimapCtx.strokeStyle = 'rgba(46, 204, 113, 0.3)';
                minimapCtx.lineWidth = 1;
                minimapCtx.beginPath();
                const viewScaleX = canvas.width * scaleX / worldWidth;
                const viewScaleY = canvas.height * scaleY / worldHeight;
                minimapCtx.rect(mx - viewScaleX / 2, my - viewScaleY / 2, viewScaleX, viewScaleY);
                minimapCtx.stroke();
            }
        }
        
        function updateTop3() {
            const top3List = document.getElementById('top3List');
            if (gameState !== 'playing') {
                top3List.innerHTML = '';
                return;
            }
            
            const allSnakes = [
                { length: player.mass || player.length, name: player.name, isPlayer: true },
                ...bots.map(b => ({ length: b.length, name: b.name, isPlayer: false }))
            ];
            allSnakes.sort((a, b) => b.length - a.length);
            top3List.innerHTML = '';
            
            for (let i = 0; i < Math.min(3, allSnakes.length); i++) {
                const snake = allSnakes[i];
                const item = document.createElement('div');
                item.className = `top3-item rank${i + 1}`;
                item.textContent = `${i + 1}. ${snake.name} (${snake.length})`;
                if (snake.isPlayer) {
                    item.style.color = '#2ECC71';
                    item.style.fontWeight = 'bold';
                }
                top3List.appendChild(item);
            }
        }

        // –≠—Ñ—Ñ–µ–∫—Ç—ã
        function createCollectEffect(x, y, color) {
            for (let i = 0; i < 8; i++) {
                const angle = (Math.PI * 2 / 8) * i;
                effects.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * 2,
                    vy: Math.sin(angle) * 2,
                    life: 20,
                    maxLife: 20,
                    size: 5,
                    color: color,
                    alpha: 1
                });
            }
        }

        function createKillEffect(x, y) {
            for (let i = 0; i < 30; i++) {
                const angle = (Math.PI * 2 / 30) * i;
                effects.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * 4,
                    vy: Math.sin(angle) * 4,
                    life: 40,
                    maxLife: 40,
                    size: 8,
                    color: '#ff3333',
                    alpha: 1
                });
            }
        }

        function createShieldEffect(x, y) {
            for (let i = 0; i < 15; i++) {
                const angle = (Math.PI * 2 / 15) * i;
                effects.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * 3,
                    vy: Math.sin(angle) * 3,
                    life: 30,
                    maxLife: 30,
                    size: 6,
                    color: '#00ffff',
                    alpha: 1
                });
            }
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            if (!canvas || !ctx) {
                // –ï—Å–ª–∏ canvas –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –µ–≥–æ —Å–Ω–æ–≤–∞
                setTimeout(gameLoop, 100);
                return;
            }
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
        if (canvas && ctx) {
            gameLoop();
            console.log('Game loop started');
        } else {
            console.error('Canvas or context not available, game loop not started');
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        let currentDirection = { x: 1, y: 0 };

        function setDirection(dx, dy) {
            if (gameState !== 'playing') return;
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É)
            const length = Math.sqrt(dx * dx + dy * dy);
            if (length > 0) {
                dx = dx / length;
                dy = dy / length;
            } else {
                return; // –ù—É–ª–µ–≤–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            }
            
            // –ù–µ–ª—å–∑—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ 180 –≥—Ä–∞–¥—É—Å–æ–≤ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞)
            const dotProduct = currentDirection.x * dx + currentDirection.y * dy;
            if (dotProduct < -0.8) return; // –£–≥–æ–ª –±–æ–ª—å—à–µ 135 –≥—Ä–∞–¥—É—Å–æ–≤
            
            currentDirection = { x: dx, y: dy };
            player.direction = { x: dx, y: dy };
        }

        // –î–∂–æ–π—Å—Ç–∏–∫
        function updateJoystick(x, y) {
            const rect = joystickBase.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > joystickRadius) {
                joystickX = (dx / distance) * joystickRadius;
                joystickY = (dy / distance) * joystickRadius;
            } else {
                joystickX = dx;
                joystickY = dy;
            }
            
            joystickHandle.style.transform = `translate(calc(-50% + ${joystickX}px), calc(-50% + ${joystickY}px))`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É, 360 –≥—Ä–∞–¥—É—Å–æ–≤)
            if (distance > 10) {
                const angle = Math.atan2(joystickY, joystickX);
                const dirX = Math.cos(angle);
                const dirY = Math.sin(angle);
                
                // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –ª—é–±–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
                setDirection(dirX, dirY);
            }
        }
        
        function resetJoystick() {
            joystickX = 0;
            joystickY = 0;
            joystickHandle.style.transform = 'translate(-50%, -50%)';
            joystickHandle.classList.remove('active');
            joystickActive = false;
        }
        
        // –°–æ–±—ã—Ç–∏—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
        joystickBase.addEventListener('mousedown', (e) => {
            if (gameState !== 'playing') return;
            joystickActive = true;
            joystickHandle.classList.add('active');
            updateJoystick(e.clientX, e.clientY);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (joystickActive && gameState === 'playing') {
                updateJoystick(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (joystickActive) {
                resetJoystick();
            }
        });
        
        // Touch —Å–æ–±—ã—Ç–∏—è
        joystickBase.addEventListener('touchstart', (e) => {
            if (gameState !== 'playing') return;
            e.preventDefault();
            joystickActive = true;
            joystickHandle.classList.add('active');
            const touch = e.touches[0];
            updateJoystick(touch.clientX, touch.clientY);
        });
        
        document.addEventListener('touchmove', (e) => {
            if (joystickActive && gameState === 'playing') {
                e.preventDefault();
                const touch = e.touches[0];
                updateJoystick(touch.clientX, touch.clientY);
            }
        });
        
        document.addEventListener('touchend', () => {
            if (joystickActive) {
                resetJoystick();
            }
        });

        // –°–≤–∞–π–ø—ã
        let touchStartX = 0;
        let touchStartY = 0;

        canvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchend', (e) => {
            if (gameState !== 'playing') return;
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;
            
            // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –ª—é–±–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ (–µ—Å–ª–∏ —Å–≤–∞–π–ø –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–π)
            if (Math.abs(dx) > 20 || Math.abs(dy) > 20) {
                setDirection(dx, dy);
            }
        });

        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (WASD –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É)
        document.addEventListener('keydown', (e) => {
            if (gameState !== 'playing') return;
            let dirX = 0;
            let dirY = 0;
            
            switch(e.key.toLowerCase()) {
                case 'w':
                case 'arrowup': dirY = -1; break;
                case 's':
                case 'arrowdown': dirY = 1; break;
                case 'a':
                case 'arrowleft': dirX = -1; break;
                case 'd':
                case 'arrowright': dirX = 1; break;
            }
            
            // –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
            if (dirX !== 0 || dirY !== 0) {
                setDirection(dirX, dirY);
            }
        });

        // –ú–∞–≥–∞–∑–∏–Ω
        function buyCrystals(amount) {
            if (tg && tg.initDataUnsafe) {
                crystals += amount;
                updateUI();
                localStorage.setItem('snakeCrystals', crystals);
                alert(`–ü–æ–ª—É—á–µ–Ω–æ ${amount} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤! (–í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –±—É–¥–µ—Ç –æ–ø–ª–∞—Ç–∞)`);
            } else {
                crystals += amount;
                updateUI();
                localStorage.setItem('snakeCrystals', crystals);
                alert(`–ü–æ–ª—É—á–µ–Ω–æ ${amount} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤! (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)`);
            }
        }

        function buyHeadType(headType, price) {
            if (crystals < price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!');
                return;
            }
            crystals -= price;
            player.headType = headType;
            currentSkin = headType;
            updateUI();
            localStorage.setItem('snakeCrystals', crystals);
            localStorage.setItem('snakeSkin', headType);
            alert('–°—Ç–∏–ª—å –≥–æ–ª–æ–≤—ã –ø—Ä–∏–º–µ–Ω–µ–Ω!');
        }

        function buyBooster(type, price) {
            if (crystals < price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!');
                return;
            }
            crystals -= price;
            if (type === 'speed') {
                activeBoosters.speed = 1800; // 30 —Å–µ–∫—É–Ω–¥
            } else if (type === 'shield') {
                activeBoosters.shield = true;
            }
            updateUI();
            localStorage.setItem('snakeCrystals', crystals);
            alert('–ë—É—Å—Ç–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
        }
        
        function changePlayerName() {
            const nameInput = document.getElementById('changeNameInput');
            if (!nameInput) return;
            
            const newName = nameInput.value.trim();
            if (newName.length > 0 && newName.length <= 15) {
                player.name = newName;
                localStorage.setItem('playerName', newName);
                alert('–ù–∏–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ' + newName);
                updateUI();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ
                const startNameInput = document.getElementById('playerNameInput');
                if (startNameInput) {
                    startNameInput.value = newName;
                }
            } else {
                alert('–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤!');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
        function initButtons() {
            startBtn = document.getElementById('startBtn');
            restartBtn = document.getElementById('restartBtn');
            shopBtn = document.getElementById('shopBtn');
            shopBtn2 = document.getElementById('shopBtn2');
            closeShopBtn = document.getElementById('closeShopBtn');
            finalScoreEl = document.getElementById('finalScore');
            finalRankEl = document.getElementById('finalRank');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –Ω–∏–∫ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            const nameInput = document.getElementById('playerNameInput');
            if (nameInput) {
                const savedName = localStorage.getItem('playerName') || '';
                nameInput.value = savedName;
            }
            
            if (startBtn) {
                startBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Start button clicked');
                    
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
                    const nameInput = document.getElementById('playerNameInput');
                    const playerName = nameInput ? (nameInput.value.trim() || '–í—ã') : '–í—ã';
                    if (playerName.length > 0) {
                        localStorage.setItem('playerName', playerName);
                    }
                    
                    console.log('Before: gameState =', gameState);
                    gameState = 'playing';
                    console.log('After: gameState =', gameState);
                    initGame();
                    console.log('initGame called, player:', player);
                    startScreen.classList.add('hidden');
                    console.log('startScreen hidden');
                    updateUI();
                });
            } else {
                console.error('startBtn not found');
            }

            if (restartBtn) {
                restartBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Restart button clicked');
                    gameState = 'playing';
                    initGame();
                    gameOverScreen.classList.remove('show');
                });
            } else {
                console.error('restartBtn not found');
            }

            if (shopBtn) {
                shopBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Shop button clicked');
                    shopScreen.classList.add('show');
                });
            } else {
                console.error('shopBtn not found');
            }

            if (shopBtn2) {
                shopBtn2.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Shop button 2 clicked');
                    shopScreen.classList.add('show');
                });
            } else {
                console.error('shopBtn2 not found');
            }

            if (closeShopBtn) {
                closeShopBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Close shop button clicked');
                    shopScreen.classList.remove('show');
                });
            } else {
                console.error('closeShopBtn not found');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ Split –∏ Eject Mass
        function splitSnake() {
            if (player.splitCooldown > 0 || player.mass < 35) return;
            
            player.splitCooldown = 300; // 5 —Å–µ–∫—É–Ω–¥ –∫—É–ª–¥–∞—É–Ω (60 FPS)
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –∑–º–µ–π–∫—É –ø–æ–ø–æ–ª–∞–º
            const halfMass = Math.floor(player.mass / 2);
            const halfLength = Math.floor(player.length / 2);
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —á–∞—Å—Ç—å - —Ä–∞–∑–º–µ—â–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∞–¥–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ direction, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞–ª–∞—Å—å –≤ —Ç–æ–º –∂–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
            const offsetX = -player.direction.x * 40;
            const offsetY = -player.direction.y * 40;
            const newPart = {
                x: player.x + offsetX,
                y: player.y + offsetY,
                body: player.body.slice(halfLength),
                direction: { x: player.direction.x, y: player.direction.y }, // –¢–æ –∂–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                speed: player.speed * 0.8, // –ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å —Ä—è–¥–æ–º
                length: halfLength,
                mass: halfMass,
                color: player.color,
                headType: player.headType,
                name: player.name,
                mergeTimer: 300 // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–ª–∏—è–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ
            };
            
            // –£–º–µ–Ω—å—à–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–º–µ–π–∫—É
            player.mass = halfMass;
            player.length = halfLength;
            player.body = player.body.slice(0, halfLength);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–∞—Å—Ç–∏
            player.parts.push(newPart);
            
            createKillEffect(player.x, player.y);
        }
        
        function ejectMass() {
            if (player.ejectCooldown > 0 || player.mass < 10) return;
            
            player.ejectCooldown = 30; // 0.5 —Å–µ–∫—É–Ω–¥—ã –∫—É–ª–¥–∞—É–Ω
            
            // –í—ã—Å—Ç—Ä–µ–ª–∏–≤–∞–µ–º —á–∞—Å—Ç—å –º–∞—Å—Å—ã
            const ejectValue = 3;
            player.mass -= ejectValue;
            player.length = Math.max(5, player.length - ejectValue);
            
            // –°–æ–∑–¥–∞–µ–º –≤—ã—Å—Ç—Ä–µ–ª–µ–Ω–Ω—É—é –º–∞—Å—Å—É
            const angle = Math.atan2(player.direction.y, player.direction.x);
            ejectedMass.push({
                x: player.x + Math.cos(angle) * 30,
                y: player.y + Math.sin(angle) * 30,
                vx: Math.cos(angle) * 5,
                vy: Math.sin(angle) * 5,
                size: 8,
                value: ejectValue,
                color: player.color,
                life: 600 // 10 —Å–µ–∫—É–Ω–¥ –∂–∏–∑–Ω–∏
            });
            
            updateUI();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–µ–π –∑–º–µ–π–∫–∏ –ø–æ—Å–ª–µ split
        function updateSnakeParts() {
            player.parts.forEach((part, index) => {
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏
                const distToMain = Math.sqrt(Math.pow(player.x - part.x, 2) + Math.pow(player.y - part.y, 2));
                
                // –ï—Å–ª–∏ —á–∞—Å—Ç—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏
                if (distToMain > 100) {
                    const angleToMain = Math.atan2(player.y - part.y, player.x - part.x);
                    part.direction.x = Math.cos(angleToMain) * 0.3 + part.direction.x * 0.7;
                    part.direction.y = Math.sin(angleToMain) * 0.3 + part.direction.y * 0.7;
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const len = Math.sqrt(part.direction.x * part.direction.x + part.direction.y * part.direction.y);
                    if (len > 0) {
                        part.direction.x /= len;
                        part.direction.y /= len;
                    }
                } else if (distToMain < 60) {
                    // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ, –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–¥–∞–ª—è–µ–º—Å—è
                    const angleAway = Math.atan2(part.y - player.y, part.x - player.x);
                    part.direction.x = Math.cos(angleAway) * 0.2 + part.direction.x * 0.8;
                    part.direction.y = Math.sin(angleAway) * 0.2 + part.direction.y * 0.8;
                    const len = Math.sqrt(part.direction.x * part.direction.x + part.direction.y * part.direction.y);
                    if (len > 0) {
                        part.direction.x /= len;
                        part.direction.y /= len;
                    }
                }
                
                // –î–≤–∏–∂–µ–Ω–∏–µ —á–∞—Å—Ç–∏
                part.x += part.direction.x * part.speed;
                part.y += part.direction.y * part.speed;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–∞
                part.body.unshift({ x: part.x, y: part.y });
                while (part.body.length > part.length) {
                    part.body.pop();
                }
                
                // –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ —Å–ª–∏—è–Ω–∏—è
                part.mergeTimer--;
                if (part.mergeTimer <= 0) {
                    // –°–ª–∏—è–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
                    if (distToMain < 50) {
                        player.mass += part.mass;
                        player.length += part.length;
                        player.parts.splice(index, 1);
                        updateUI();
                    }
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ Split –∏ Eject
        function initActionButtons() {
            const splitBtn = document.getElementById('splitBtn');
            const ejectBtn = document.getElementById('ejectBtn');
            
            if (splitBtn) {
                splitBtn.addEventListener('click', () => {
                    if (gameState === 'playing') {
                        splitSnake();
                    }
                });
            }
            
            if (ejectBtn) {
                let ejectInterval = null;
                ejectBtn.addEventListener('mousedown', () => {
                    if (gameState === 'playing') {
                        ejectMass();
                        ejectInterval = setInterval(() => {
                            if (gameState === 'playing') {
                                ejectMass();
                            }
                        }, 100);
                    }
                });
                
                ejectBtn.addEventListener('mouseup', () => {
                    if (ejectInterval) {
                        clearInterval(ejectInterval);
                        ejectInterval = null;
                    }
                });
                
                ejectBtn.addEventListener('mouseleave', () => {
                    if (ejectInterval) {
                        clearInterval(ejectInterval);
                        ejectInterval = null;
                    }
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initButtons();
                initActionButtons();
            });
        } else {
            initButtons();
            initActionButtons();
        }

        // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
        function gameOver() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–¥–µ—Ç (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)
            if (gameState === 'gameover' || gameState !== 'playing') return;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–≥—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!player || !player.body || player.body.length === 0) return;
            
            // –ï—â–µ –æ–¥–Ω–∞ –∑–∞—â–∏—Ç–∞ - –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π
            // (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
            if ((player.mass || player.length) < 10) {
                console.log('–ó–∞—â–∏—Ç–∞: –∏–≥—Ä–æ–∫ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π –¥–ª—è gameOver');
                return;
            }
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã (–≤ —Ç–µ—á–µ–Ω–∏–µ 30 –∫–∞–¥—Ä–æ–≤)
            if (player.lastFoodTime && gameFrame && (gameFrame - player.lastFoodTime) < 30) {
                console.log('–ó–∞—â–∏—Ç–∞: —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –ø–æ—Å–ª–µ –ø–æ–µ–¥–∞–Ω–∏—è –µ–¥—ã');
                return;
            }
            
            gameState = 'gameover';
            const playerMass = player.mass || player.length;
            const allSnakes = [{ length: playerMass, isPlayer: true }, ...bots.map(b => ({ length: b.mass || b.length, isPlayer: false }))];
            allSnakes.sort((a, b) => b.length - a.length);
            const rank = allSnakes.findIndex(s => s.isPlayer) + 1;
            
            if (finalScoreEl) finalScoreEl.textContent = `–î–ª–∏–Ω–∞: ${player.length}`;
            if (finalRankEl) finalRankEl.textContent = `–ú–µ—Å—Ç–æ: #${rank}`;
            if (gameOverScreen) gameOverScreen.classList.add('show');
        }
    </script>
</body>
</html>

